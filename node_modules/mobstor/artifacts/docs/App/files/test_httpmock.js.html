<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test/httpmock.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Client.html">Client</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/mobstor.html">mobstor</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: test/httpmock.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*
 * Copyright (c) 2011 Yahoo! Inc. All rights reserved.
 */

var sys = require(&#x27;sys&#x27;), 
    fs = require(&#x27;fs&#x27;), 
    url = require(&#x27;url&#x27;), 
    path = require(&#x27;path&#x27;), 
    Stream = require(&quot;stream&quot;).Stream, 
    util = require(&#x27;util&#x27;), 
    qs = require(&#x27;querystring&#x27;), 
    events = require(&quot;events&quot;),
    StringDecoder = require(&#x27;string_decoder&#x27;).StringDecoder;

/**
 * MObStor mock object response class
 * 
 * @private
 * @constructor
 * @param options {Object} Mock object option
 * @param request {MObStorMockRequest}  HTTP/HTTPS request option
 * @returns {MObStorMockResponse}
 */
var MObStorMockResponse = function (options, request) {
    // mock object options
    this._options = options;
    // http request options
    this._request = request;
    
    this._decoder = new StringDecoder(this._options.defaultEncoding);
    
    // callback function storage
    this._callback = {};
    
    this.statusCode = 200;
    this.httpVersion = this._options.version;
    this.complete = true;

    var service=&quot;&quot;;
    if(this._request.url &amp;&amp; this._request.url.host) {
        service=this._request.url.host;
    }
    else {
        service=this._request.host;
    }



    var temp_stream=null;
    for(i=0;i&lt;this._options[service].senario.length;i++) {
        var senario=this._options[service].senario[i];

        if(senario.request.path===this._request.url.pathname &amp;&amp; senario.request.method===this._request.method) {
            if(senario.request.saveBody) {
                var data=fs.readFileSync(&#x27;/tmp/inbuffer&#x27;,&#x27;binary&#x27;);
                fs.writeFileSync(senario.request.saveBody, data,&#x27;binary&#x27;);
            }
            
            if(senario.response.readBody) {
                try {
                    fs.statSync(senario.response.readBody);
                    this.outstream = fs.createReadStream(senario.response.readBody, {
                        &#x27;flags&#x27; : &#x27;r&#x27;,
                        &#x27;encoding&#x27; : null,
                        &#x27;mode&#x27; : 438
                    });
                }
                catch(e) {
                    // 404????
                }
            }
            else if(senario.response.body) {
                temp_stream = fs.createWriteStream(&#x27;/tmp/outbuffer&#x27;, {
                    &#x27;flags&#x27; : &#x27;w&#x27;,
                    &#x27;encoding&#x27; : null,
                    &#x27;mode&#x27; : 438
                });
                temp_stream.write(senario.response.body);
                temp_stream.end();
                
                this.outstream = fs.createReadStream(&#x27;/tmp/outbuffer&#x27;, {
                    &#x27;flags&#x27; : &#x27;r&#x27;,
                    &#x27;encoding&#x27; : null,
                    &#x27;mode&#x27; : 438
                });
            }

            
            this.statusCode = senario.response.statusCode;
            this.headers = senario.response.headers || {};
            
            break;
        }
    }

    if(!this.outstream) {
        temp_stream = fs.createWriteStream(&#x27;/tmp/outbuffer&#x27;, {
            &#x27;flags&#x27; : &#x27;w&#x27;,
            &#x27;encoding&#x27; : null,
            &#x27;mode&#x27; : 438
        });
        temp_stream.write(&quot;NOT HANDLED&quot;);
        temp_stream.end();
        
        this.outstream = fs.createReadStream(this._options[service].storage+&#x27;/outbuffer&#x27;, {
            &#x27;flags&#x27; : &#x27;r&#x27;,
            &#x27;encoding&#x27; : null,
            &#x27;mode&#x27; : 438
        });
    }    

    if(this.outstream!==null) {
        var self = this;

        // compose Content-Length header
        try {
            var stat = fs.statSync(this.outstream.path);
            if (stat) {
                this.headers[&#x27;content-length&#x27;] = stat.size;
            }
        }
        catch(ee) { }
        
        // add event handlers
        this.outstream.on(&#x27;data&#x27;, function(chunk) {
            if (self._callback.data &amp;&amp; typeof self._callback.data === &#x27;function&#x27;) {
                self._callback.data.call(self.outstream, chunk);
            }
        });
        
        this.outstream.on(&#x27;end&#x27;, function() {
            if (self._callback.end &amp;&amp; typeof self._callback.end === &#x27;function&#x27;) {
                self._callback.end.call(self.outstream);
            }
        });
        
        this.outstream.on(&#x27;error&#x27;, function(exception) {
            if (self._callback.error &amp;&amp; typeof self._callback.error === &#x27;function&#x27;) {
                self._callback.error.call(self.outstream, exception);
            }
        });
        
        this.outstream.on(&#x27;close&#x27;, function() {
            if (self._callback.close &amp;&amp; typeof self._callback.close === &#x27;function&#x27;) {
                self._callback.close.call(self.outstream);
            }
        });
        
        this.outstream.on(&#x27;fd&#x27;, function(fd) {
            if (self._callback.fd &amp;&amp; typeof self._callback.fd === &#x27;function&#x27;) {
                self._callback.fd.call(self.outstream, fd);
            }
        });
        
        this.paused = this.outstream.paused;
        this.readable = this.outstream.readable;
    }
    else {
        if (this._callback.error &amp;&amp; typeof this._callback.error === &#x27;function&#x27;) {
            this._callback.error.call(self.outstream, exception);
        }
    }    
};

// Stream inheritance
util.inherits(MObStorMockResponse, Stream);

MObStorMockResponse.prototype.on = function(type, callback) {
    this._callback[type] = callback;
};

MObStorMockResponse.prototype.setEncoding = function(encoding) {
    this._decoder = new StringDecoder(encoding);
};

MObStorMockResponse.prototype.pause = function() {
    this.outstream.pause();
    this.paused = this.outstream.paused;
    this.readable = this.outstream.readable;
};

MObStorMockResponse.prototype.resume = function() {
    this.outstream.resume();
    this.paused = this.outstream.paused;
    this.readable = this.outstream.readable;
};

MObStorMockResponse.prototype.end = function() {
    this.outstream.end();
    this.paused = this.outstream.paused;
    this.readable = this.outstream.readable;
};

MObStorMockResponse.prototype.destroy = function() {
    this.outstream.destroy();
    this.paused = this.outstream.paused;
    this.readable = this.outstream.readable;
};

MObStorMockResponse.prototype.destroySoon = function() {
    this.outstream.destroySoon();
    this.paused = this.outstream.paused;
    this.readable = this.outstream.readable;
};

MObStorMockResponse.prototype.pipe = function(destination, options) {
    return this.outstream.pipe(destination, options);
};

/**
 * MObStor mock request class
 * 
 * @private
 * @author pitecus
 * @constructor
 * @param optionss
 *            {Object} Same object as HTTP, HTTPS class
 */
var MObStorMockRequest = function (options) {
    Stream.call(this);
    
    if(!options) {
        throw new Error(&#x27;Invalid Parameter&#x27;);
    }
    
    this._options = options;
    this._options.maxAged = {}; // max aged resource storage hash object
    
    this._decoder = new StringDecoder(this._options.defaultEncoding);
    this.setTimeout = function(timeout, cb) {
    };
    
    this.aborted = false;
    this.abort = function () {
        this.aborted = true;
    };
};

util.inherits(MObStorMockRequest, Stream);

/**
 * mock HTTP/HTTPS.reqeust(option) method
 * 
 * @param options
 */
MObStorMockRequest.prototype.request = function(options) {
    this._request = options;
    
    this._callback = {};
    this._length =0;
    
    if (options.path) {
        this._request.url = url.parse(options.path);
    }
    
    var service=&quot;&quot;;
    if(this._request.url &amp;&amp; this._request.url.host) {
        service=this._request.url.host;
    }
    else {
        service=this._request.host;
    }
    
    this._instream = fs.createWriteStream(this._options[service].storage+&#x27;/inbuffer&#x27;, {
        &#x27;flags&#x27; : &#x27;w&#x27;,
        &#x27;encoding&#x27; : null,
        &#x27;mode&#x27; : 438
    });
    

    var self = this;
    if (this._instream) {
        this._instream.on(&#x27;data&#x27;, function(chunk) {
            if (self._callback.data &amp;&amp; typeof self._callback.data === &#x27;function&#x27;) {
                self._callback.data.call(self._instream, chunk);
            }
        });
        
        this._instream.on(&#x27;end&#x27;, function() {
            if (self._callback.end &amp;&amp; typeof self._callback.end === &#x27;function&#x27;) {
                self._callback.end.call(self._instream);
            }
        });
        
        this._instream.on(&#x27;error&#x27;, function(exception) {
            if (self._callback.error &amp;&amp; typeof self._callback.error === &#x27;function&#x27;) {
                self._callback.error.call(self._instream, exception);
            }
        });
        
        this._instream.on(&#x27;close&#x27;, function() {

            // trigger response event 
            if (typeof self._callback.response === &#x27;function&#x27;) {
                var response = new MObStorMockResponse(self._options, self._request);
                self._callback.response.call(self._instream, response);
            }
            
            if (self._callback.close &amp;&amp; typeof self._callback.close === &#x27;function&#x27;) {
                self._callback.close.call(self._instream);
            }
        });
        
        this._instream.on(&#x27;fd&#x27;, function(fd) {
            if (self._callback.fd &amp;&amp; typeof self._callback.fd === &#x27;function&#x27;) {
                self._callback.fd.call(self._instream, fd);
            }
        });
        
        this.writable = this._instream.writable;
    }
    
    
    return this;
};

MObStorMockRequest.prototype.on = function(type, callback) {
    this._callback[type] = callback;
    return this;
};

MObStorMockRequest.prototype.setEncoding = function(encoding) {
    this._decoder = new StringDecoder(encoding);
};

MObStorMockRequest.prototype.pause = function() {
    this._instream.pause();
};

MObStorMockRequest.prototype.resume = function() {
    this._instream.resume();
};

MObStorMockRequest.prototype.flush = function() {
    this._instream.flush();
};

MObStorMockRequest.prototype.end = function(data, encoding, cb) {
    this._instream.end(cb);
};

MObStorMockRequest.prototype.destroy = function(cb) {
    this._instream.destroy(cb);
};

MObStorMockRequest.prototype.destroy = function(cb) {
    this._instream.destroy(cb);
};

MObStorMockRequest.prototype.end = function() {
    this._instream.end();
    return this;
};

MObStorMockRequest.prototype.write = function(chunk, encoding) {
    this._length +=chunk.length;
    if (this._instream.writable) {
        this._instream.write(chunk);
    }
    else {
        throw Error(&#x27;can not send the request&#x27;);
    }
    return this;
};

exports.init = function(config) {
    return new MObStorMockRequest(config);
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
